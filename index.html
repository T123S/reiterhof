<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Pferde-Simulator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #111; }
        canvas { display: block; }

        #ui-container {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            max-width: 300px;
            z-index: 100;
        }

        h2 { margin-top: 0; color: #2c3e50; font-size: 1.2em; }
        .config-section { margin-bottom: 15px; border-bottom: 1px solid #ddd; padding-bottom: 10px; }
        .row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
        label { font-size: 0.9em; color: #555; }
        input[type="color"] { border: none; width: 30px; height: 30px; cursor: pointer; background: none; }
        
        button {
            width: 100%;
            padding: 10px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }
        button:hover { background: #219150; }

        #controls-hint {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.6);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            pointer-events: none;
            text-align: center;
        }

        #interaction-msg {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.8);
            padding: 10px 20px;
            border-radius: 8px;
            display: none;
            font-weight: bold;
        }
    </style>
</head>
<body>

<div id="ui-container">
    <h2>Konfiguration</h2>
    
    <div class="config-section">
        <strong>Mensch</strong>
        <div class="row">
            <label>Hautfarbe</label>
            <input type="color" id="skinColor" value="#ffdbac">
        </div>
        <div class="row">
            <label>Shirt</label>
            <input type="color" id="shirtColor" value="#3498db">
        </div>
        <div class="row">
            <label>Hose</label>
            <input type="color" id="pantsColor" value="#2c3e50">
        </div>
    </div>

    <div class="config-section">
        <strong>Pferd</strong>
        <div class="row">
            <label>Fellfarbe</label>
            <input type="color" id="horseColor" value="#8b4513">
        </div>
        <div class="row">
            <label>Mähne/Schweif</label>
            <input type="color" id="maneColor" value="#4a270a">
        </div>
    </div>

    <button id="startBtn">Simulation Starten</button>
</div>

<div id="controls-hint">
    WASD / Pfeiltasten: Bewegen | [L]: Leine nehmen/loslassen | Maus: Kamera drehen
</div>

<div id="interaction-msg">Drücke [L] für die Leine</div>

<script>
    let scene, camera, renderer, player, horse, ground, leash;
    let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false;
    let isLeashed = false;
    let cameraAngle = { phi: Math.PI / 4, theta: Math.PI / 4 };
    let mouseX = 0, mouseY = 0, isMouseDown = false;

    // Game Objects
    let playerGroup = new THREE.Group();
    let horseGroup = new THREE.Group();
    let trees = [];

    function init() {
        // Setup Scene
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87ceeb); // Sky blue
        
        // Camera
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        
        // Renderer
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        // Lights
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);

        const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
        dirLight.position.set(50, 100, 50);
        dirLight.castShadow = true;
        dirLight.shadow.camera.left = -50;
        dirLight.shadow.camera.right = 50;
        dirLight.shadow.camera.top = 50;
        dirLight.shadow.camera.bottom = -50;
        scene.add(dirLight);

        // Ground
        const groundGeo = new THREE.PlaneGeometry(200, 200);
        const groundMat = new THREE.MeshStandardMaterial({ color: 0x27ae60 });
        ground = new THREE.Mesh(groundGeo, groundMat);
        ground.rotation.x = -Math.PI / 2;
        ground.receiveShadow = true;
        scene.add(ground);

        // Decor: Some Trees
        for(let i=0; i<30; i++) {
            createTree(Math.random()*160-80, Math.random()*160-80);
        }

        createPlayer();
        createHorse();

        // Leash Line
        const leashMat = new THREE.LineBasicMaterial({ color: 0x000000 });
        const leashPoints = [];
        leashPoints.push(new THREE.Vector3(0, 0, 0));
        leashPoints.push(new THREE.Vector3(0, 0, 0));
        const leashGeo = new THREE.BufferGeometry().setFromPoints(leashPoints);
        leash = new THREE.Line(leashGeo, leashMat);
        leash.visible = false;
        scene.add(leash);

        // Event Listeners
        window.addEventListener('keydown', (e) => handleKey(e.code, true));
        window.addEventListener('keyup', (e) => handleKey(e.code, false));
        window.addEventListener('resize', onWindowResize);
        
        // Camera Rotation handling
        window.addEventListener('mousedown', () => isMouseDown = true);
        window.addEventListener('mouseup', () => isMouseDown = false);
        window.addEventListener('mousemove', (e) => {
            if (isMouseDown) {
                cameraAngle.theta -= e.movementX * 0.01;
                cameraAngle.phi -= e.movementY * 0.01;
                cameraAngle.phi = Math.max(0.1, Math.min(Math.PI / 2.1, cameraAngle.phi));
            }
        });

        document.getElementById('startBtn').onclick = () => {
            updateVisuals();
            document.getElementById('ui-container').style.display = 'none';
        };

        // Initial update
        updateVisuals();
        animate();
    }

    function createTree(x, z) {
        const treeGroup = new THREE.Group();
        const trunkGeo = new THREE.CylinderGeometry(0.2, 0.4, 2);
        const trunkMat = new THREE.MeshStandardMaterial({ color: 0x5d4037 });
        const trunk = new THREE.Mesh(trunkGeo, trunkMat);
        trunk.position.y = 1;
        trunk.castShadow = true;
        treeGroup.add(trunk);

        const leavesGeo = new THREE.SphereGeometry(1.2, 8, 8);
        const leavesMat = new THREE.MeshStandardMaterial({ color: 0x1b5e20 });
        const leaves = new THREE.Mesh(leavesGeo, leavesMat);
        leaves.position.y = 2.5;
        leaves.castShadow = true;
        treeGroup.add(leaves);

        treeGroup.position.set(x, 0, z);
        scene.add(treeGroup);
        trees.push(treeGroup);
    }

    function createPlayer() {
        // Head
        const headGeo = new THREE.SphereGeometry(0.25, 16, 16);
        const headMat = new THREE.MeshStandardMaterial({ color: 0xffdbac });
        const head = new THREE.Mesh(headGeo, headMat);
        head.name = "skin";
        head.position.y = 1.7;
        playerGroup.add(head);

        // Body
        const bodyGeo = new THREE.BoxGeometry(0.5, 0.7, 0.3);
        const bodyMat = new THREE.MeshStandardMaterial({ color: 0x3498db });
        const body = new THREE.Mesh(bodyGeo, bodyMat);
        body.name = "shirt";
        body.position.y = 1.2;
        playerGroup.add(body);

        // Legs
        const legGeo = new THREE.BoxGeometry(0.2, 0.8, 0.2);
        const legMat = new THREE.MeshStandardMaterial({ color: 0x2c3e50 });
        const legR = new THREE.Mesh(legGeo, legMat);
        legR.name = "pants";
        legR.position.set(0.15, 0.4, 0);
        playerGroup.add(legR);
        
        const legL = new THREE.Mesh(legGeo, legMat);
        legL.name = "pants";
        legL.position.set(-0.15, 0.4, 0);
        playerGroup.add(legL);

        playerGroup.position.set(0, 0, 5);
        playerGroup.traverse(c => { if(c.isMesh) c.castShadow = true; });
        scene.add(playerGroup);
        player = playerGroup;
    }

    function createHorse() {
        const horseMat = new THREE.MeshStandardMaterial({ color: 0x8b4513 });
        const maneMat = new THREE.MeshStandardMaterial({ color: 0x4a270a });

        // Body
        const bodyGeo = new THREE.BoxGeometry(0.8, 0.8, 1.6);
        const body = new THREE.Mesh(bodyGeo, horseMat);
        body.name = "fur";
        body.position.y = 1;
        horseGroup.add(body);

        // Neck
        const neckGeo = new THREE.BoxGeometry(0.4, 0.7, 0.4);
        const neck = new THREE.Mesh(neckGeo, horseMat);
        neck.name = "fur";
        neck.position.set(0, 1.5, 0.7);
        neck.rotation.x = -0.4;
        horseGroup.add(neck);

        // Head
        const headGeo = new THREE.BoxGeometry(0.4, 0.4, 0.6);
        const head = new THREE.Mesh(headGeo, horseMat);
        head.name = "fur";
        head.position.set(0, 1.8, 1.0);
        horseGroup.add(head);

        // Legs
        const legGeo = new THREE.CylinderGeometry(0.1, 0.1, 0.8);
        const legFL = new THREE.Mesh(legGeo, horseMat);
        legFL.name = "fur";
        legFL.position.set(0.25, 0.4, 0.6);
        horseGroup.add(legFL);

        const legFR = new THREE.Mesh(legGeo, horseMat);
        legFR.name = "fur";
        legFR.position.set(-0.25, 0.4, 0.6);
        horseGroup.add(legFR);

        const legBL = new THREE.Mesh(legGeo, horseMat);
        legBL.name = "fur";
        legBL.position.set(0.25, 0.4, -0.6);
        horseGroup.add(legBL);

        const legBR = new THREE.Mesh(legGeo, horseMat);
        legBR.name = "fur";
        legBR.position.set(-0.25, 0.4, -0.6);
        horseGroup.add(legBR);

        // Mane
        const maneGeo = new THREE.BoxGeometry(0.1, 0.8, 0.2);
        const mane = new THREE.Mesh(maneGeo, maneMat);
        mane.name = "mane";
        mane.position.set(0, 1.6, 0.5);
        horseGroup.add(mane);

        // Tail
        const tailGeo = new THREE.BoxGeometry(0.1, 0.6, 0.1);
        const tail = new THREE.Mesh(tailGeo, maneMat);
        tail.name = "mane";
        tail.position.set(0, 0.9, -0.85);
        tail.rotation.x = 0.5;
        horseGroup.add(tail);

        horseGroup.position.set(3, 0, 3);
        horseGroup.traverse(c => { if(c.isMesh) c.castShadow = true; });
        scene.add(horseGroup);
        horse = horseGroup;
    }

    function updateVisuals() {
        const skinC = document.getElementById('skinColor').value;
        const shirtC = document.getElementById('shirtColor').value;
        const pantsC = document.getElementById('pantsColor').value;
        const furC = document.getElementById('horseColor').value;
        const maneC = document.getElementById('maneColor').value;

        player.traverse(c => {
            if(c.name === "skin") c.material.color.set(skinC);
            if(c.name === "shirt") c.material.color.set(shirtC);
            if(c.name === "pants") c.material.color.set(pantsC);
        });

        horse.traverse(c => {
            if(c.name === "fur") c.material.color.set(furC);
            if(c.name === "mane") c.material.color.set(maneC);
        });
    }

    function handleKey(code, isPressed) {
        switch(code) {
            case 'ArrowUp':
            case 'KeyW': moveForward = isPressed; break;
            case 'ArrowDown':
            case 'KeyS': moveBackward = isPressed; break;
            case 'ArrowLeft':
            case 'KeyA': moveLeft = isPressed; break;
            case 'ArrowRight':
            case 'KeyD': moveRight = isPressed; break;
            case 'KeyL':
                if (isPressed) toggleLeash();
                break;
        }
    }

    function toggleLeash() {
        const dist = player.position.distanceTo(horse.position);
        if (!isLeashed) {
            if (dist < 3) {
                isLeashed = true;
                leash.visible = true;
            }
        } else {
            isLeashed = false;
            leash.visible = false;
        }
    }

    function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function animate() {
        requestAnimationFrame(animate);
        
        // Movement Logic
        const speed = 0.1;
        let direction = new THREE.Vector3();
        
        if (moveForward || moveBackward || moveLeft || moveRight) {
            // Get camera orientation for movement direction
            const forward = new THREE.Vector3();
            camera.getWorldDirection(forward);
            forward.y = 0;
            forward.normalize();

            const right = new THREE.Vector3().crossVectors(new THREE.Vector3(0, 1, 0), forward).normalize();

            if (moveForward) direction.add(forward);
            if (moveBackward) direction.sub(forward);
            if (moveLeft) direction.add(right);
            if (moveRight) direction.sub(right);

            if (direction.length() > 0) {
                direction.normalize().multiplyScalar(speed);
                player.position.add(direction);
                
                // Rotate player to face move direction
                const targetRotation = Math.atan2(direction.x, direction.z);
                player.rotation.y = targetRotation;

                // Procedural Walk Animation (Bobbing)
                player.children.forEach(child => {
                    if (child.name === "pants") {
                        const side = child.position.x > 0 ? 1 : -1;
                        child.rotation.x = Math.sin(Date.now() * 0.01) * 0.5 * side;
                    }
                });
            }
        } else {
            // Reset leg rotation when idle
            player.children.forEach(child => {
                if (child.name === "pants") child.rotation.x = 0;
            });
        }

        // Horse Follow Logic (Leash)
        if (isLeashed) {
            const followDist = 2.0;
            const horseToPlayer = new THREE.Vector3().subVectors(player.position, horse.position);
            const dist = horseToPlayer.length();
            
            if (dist > followDist) {
                horseToPlayer.y = 0;
                horseToPlayer.normalize();
                horse.position.add(horseToPlayer.multiplyScalar(speed * 0.9));
                
                // Horse faces player
                const horseTargetRotation = Math.atan2(horseToPlayer.x, horseToPlayer.z);
                horse.rotation.y = THREE.MathUtils.lerp(horse.rotation.y, horseTargetRotation, 0.1);
            }

            // Update Leash Line
            const playerHand = player.position.clone().add(new THREE.Vector3(0, 1.2, 0));
            const horseNeck = horse.position.clone().add(new THREE.Vector3(0, 1.5, 0.5).applyAxisAngle(new THREE.Vector3(0,1,0), horse.rotation.y));
            
            const positions = leash.geometry.attributes.position.array;
            positions[0] = playerHand.x;
            positions[1] = playerHand.y;
            positions[2] = playerHand.z;
            positions[3] = horseNeck.x;
            positions[4] = horseNeck.y;
            positions[5] = horseNeck.z;
            leash.geometry.attributes.position.needsUpdate = true;
        }

        // Show interaction message if near horse
        const interactMsg = document.getElementById('interaction-msg');
        if (!isLeashed && player.position.distanceTo(horse.position) < 3) {
            interactMsg.style.display = 'block';
        } else {
            interactMsg.style.display = 'none';
        }

        // Camera Follow (3rd Person)
        const radius = 8;
        camera.position.x = player.position.x + radius * Math.sin(cameraAngle.phi) * Math.sin(cameraAngle.theta);
        camera.position.y = player.position.y + radius * Math.cos(cameraAngle.phi);
        camera.position.z = player.position.z + radius * Math.sin(cameraAngle.phi) * Math.cos(cameraAngle.theta);
        camera.lookAt(player.position.x, player.position.y + 1, player.position.z);

        renderer.render(scene, camera);
    }

    window.onload = init;
</script>

</body>
</html>